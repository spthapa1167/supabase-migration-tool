<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Edge Function Comparison: dev â†’ test</title>
<style>
body { font-family: 'Inter', sans-serif; background: #f8fafc; color: #0f172a; margin: 0; padding: 32px; }
.container { max-width: 960px; margin: 0 auto; background: white; border-radius: 24px; box-shadow: 0 24px 48px rgba(15, 23, 42, 0.12); padding: 32px; }
.metrics { display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 32px; }
.metric-card { flex: 1 1 180px; background: linear-gradient(135deg, rgba(99,102,241,.1), rgba(129,140,248,.06)); border: 1px solid rgba(99,102,241,.2); border-radius: 16px; padding: 16px; }
.metric-card h3 { font-size: .85rem; letter-spacing: .04em; color: #4338ca; margin-bottom: 6px; text-transform: uppercase; }
.metric-card p { font-size: 1.6rem; font-weight: 700; color: #1e1b4b; }
.snapshots { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 32px; }
.snapshot-card { border: 1px solid rgba(148,163,184,.3); border-radius: 20px; padding: 20px; background: rgba(248,250,252,.9); }
.snapshot-card h3 { font-size: 1rem; font-weight: 600; margin-bottom: 12px; color: #1e1b4b; }
.snapshot-card ul { list-style: none; margin: 0; padding: 0; max-height: 220px; overflow-y: auto; }
.snapshot-card li { padding: 6px 10px; border-radius: 10px; background: rgba(148,163,184,.12); margin-bottom: 6px; color: #334155; font-size: .9rem; }
.edge-table { width: 100%; border-collapse: collapse; margin-top: 8px; }
.edge-table th, .edge-table td { border: 1px solid rgba(148,163,184,.35); padding: 12px; text-align: left; vertical-align: top; }
.edge-table thead { background: rgba(99,102,241,.08); color: #312e81; }
.badge { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 999px; font-size: .75rem; font-weight: 600; }
.badge-add { background: rgba(34,197,94,.15); color: #166534; }
.badge-remove { background: rgba(248,113,113,.15); color: #991b1b; }
.badge-modify { background: rgba(251,191,36,.15); color: #92400e; }
pre { font-family: 'JetBrains Mono', monospace; font-size: .85rem; background: #0f172a; color: #e2e8f0; padding: 12px; border-radius: 12px; max-height: 240px; overflow-y: auto; white-space: pre-wrap; }
.no-diff { font-size: 1rem; color: #475569; margin-top: 8px; }
</style>
</head>
<body>
    <div class="container">
        <h1>Edge Function Comparison</h1>
        <p class="meta">Synchronize <strong>dev</strong> â†’ <strong>test</strong></p>
        <div class="metrics">
            <div class="metric-card"><h3>Source Functions</h3><p>14</p></div>
            <div class="metric-card"><h3>Target Functions</h3><p>13</p></div>
            <div class="metric-card"><h3>To Deploy</h3><p>1</p></div>
            <div class="metric-card"><h3>To Redeploy</h3><p>2</p></div>
            <div class="metric-card"><h3>Review Target-Only</h3><p>0</p></div>
        </div>
        <div class="snapshots">
            <div class="snapshot-card">
                <h3>Source (dev)</h3>
                <ul><li>ai-chat</li><li>ai-news</li><li>contact-email</li><li>crawl-website</li><li>create-course-payment</li><li>knowledge-chat</li><li>llm-leaderboard</li><li>llm-leaderboard-free</li><li>process-document</li><li>seed-initial-content</li><li>send-enrollment-confirmation</li><li>stripe-transactions</li><li>system-info</li><li>verify-payment-email</li></ul>
            </div>
            <div class="snapshot-card">
                <h3>Target (test)</h3>
                <ul><li>ai-chat</li><li>ai-news</li><li>contact-email</li><li>crawl-website</li><li>create-course-payment</li><li>knowledge-chat</li><li>llm-leaderboard</li><li>llm-leaderboard-free</li><li>process-document</li><li>seed-initial-content</li><li>send-enrollment-confirmation</li><li>system-info</li><li>verify-payment-email</li></ul>
            </div>
        </div>
        <table class="edge-table">
            <thead>
                <tr>
                    <th>Function</th>
                    <th>Action</th>
                    <th>Summary</th>
                    <th>Diff</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                        <td>send-enrollment-confirmation</td>
                        <td><span class="badge badge-modify">Redeploy</span></td>
                        <td>Code differs</td>
                        <td><pre>--- target:send-enrollment-confirmation/index.ts
+++ source:send-enrollment-confirmation/index.ts
--- /var/folders/mw/zbyc_w_13bvgzfdsckg2sqn40000gn/T/edge-tgt-1762566401892-0.2608609618742599	2025-11-07 19:46:41
+++ /var/folders/mw/zbyc_w_13bvgzfdsckg2sqn40000gn/T/edge-src-1762566401892-0.6930337091016149	2025-11-07 19:46:41
@@ -20,6 +20,22 @@
     });
     const supabase = createClient(Deno.env.get("SUPABASE_URL") ?? "", Deno.env.get("SUPABASE_SERVICE_ROLE_KEY") ?? "");
     const resend = new Resend(Deno.env.get("RESEND_API_KEY"));
+    // Fetch active training program from database
+    const { data: programData, error: programError } = await supabase.from("training_programs").select("title, start_date, duration, class_size").eq("is_active", true).order("created_at", {
+      ascending: false
+    }).limit(1).maybeSingle();
+    if (programError) {
+      console.error("Error fetching training program:", programError);
+    }
+    const courseTitle = programData?.title || "AI Engineering: 12-Week Project-Based Course";
+    const startDate = programData?.start_date ? new Date(programData.start_date).toLocaleDateString('en-US', {
+      month: 'long',
+      day: 'numeric',
+      year: 'numeric',
+      weekday: 'long'
+    }) : "January 4, 2026 (Sunday)";
+    const duration = programData?.duration || "12 weeks";
+    const batchSize = programData?.class_size || 10;
     // Get the checkout session
     const session = await stripe.checkout.sessions.retrieve(sessionId, {
       expand: [
@@ -131,11 +147,11 @@
             <div style="background: #f8fafc; border-radius: 12px; padding: 30px; margin-bottom: 30px; border-left: 4px solid #3b82f6;">
               <h3 style="color: #1e293b; margin: 0 0 20px 0; font-size: 20px;">Course Details</h3>
               <table style="width: 100%; border-collapse: collapse;">
-                <tr><td style="padding: 8px 0; color: #475569; font-weight: 600;">Course:</td><td style="padding: 8px 0; color: #1e293b;">AI Engineering: 12-Week Project-Based Course</td></tr>
-                <tr><td style="padding: 8px 0; color: #475569; font-weight: 600;">Start Date:</td><td style="padding: 8px 0; color: #1e293b;">January 4, 2026 (Sunday)</td></tr>
+                <tr><td style="padding: 8px 0; color: #475569; font-weight: 600;">Course:</td><td style="padding: 8px 0; color: #1e293b;">${courseTitle}</td></tr>
+                <tr><td style="padding: 8px 0; color: #475569; font-weight: 600;">Start Date:</td><td style="padding: 8px 0; color: #1e293b;">${startDate}</td></tr>
                 <tr><td style="padding: 8px 0; color: #475569; font-weight: 600;">Schedule:</td><td style="padding: 8px 0; color: #1e293b;">Sundays, 11:00 AM CST (2 hours per week)</td></tr>
-                <tr><td style="padding: 8px 0; color: #475569; font-weight: 600;">Duration:</td><td style="padding: 8px 0; color: #1e293b;">12 weeks</td></tr>
-                <tr><td style="padding: 8px 0; color: #475569; font-weight: 600;">Batch Size:</td><td style="padding: 8px 0; color: #1e293b;">Max 10 students per batch</td></tr>
+                <tr><td style="padding: 8px 0; color: #475569; font-weight: 600;">Duration:</td><td style="padding: 8px 0; color: #1e293b;">${duration}</td></tr>
+                <tr><td style="padding: 8px 0; color: #475569; font-weight: 600;">Batch Size:</td><td style="padding: 8px 0; color: #1e293b;">Max ${batchSize} students per batch</td></tr>
               </table>
             </div>
             
@@ -182,7 +198,9 @@
       <p><strong>Email:</strong> ${email}</p>
       <p><strong>Amount Paid:</strong> $${amount}</p>
       <p><strong>Transaction ID:</strong> ${sessionId}</p>
-      <p><strong>Course:</strong> AI Engineering: 12-Week Project-Based Course</p>
+      <p><strong>Course:</strong> ${courseTitle}</p>
+      <p><strong>Start Date:</strong> ${startDate}</p>
+      <p><strong>Duration:</strong> ${duration}</p>
       ${attachments.length > 0 ? '<p>ðŸ“Ž Invoice and receipt attached</p>' : ''}
     `;
     // Send customer email</pre></td>
                    </tr><tr>
                        <td>stripe-transactions</td>
                        <td><span class="badge badge-add">Deploy</span></td>
                        <td>Present only in source</td>
                        <td>No diff available</td>
                    </tr><tr>
                        <td>verify-payment-email</td>
                        <td><span class="badge badge-modify">Redeploy</span></td>
                        <td>Code differs</td>
                        <td><pre>--- target:verify-payment-email/index.ts
+++ source:verify-payment-email/index.ts
--- /var/folders/mw/zbyc_w_13bvgzfdsckg2sqn40000gn/T/edge-tgt-1762566401899-0.19649119218985123	2025-11-07 19:46:41
+++ /var/folders/mw/zbyc_w_13bvgzfdsckg2sqn40000gn/T/edge-src-1762566401899-0.9013444283402476	2025-11-07 19:46:41
@@ -22,6 +22,22 @@
     const resend = new Resend(resendKey);
     // Initialize Supabase client for file storage
     const supabase = createClient(Deno.env.get("SUPABASE_URL") ?? "", Deno.env.get("SUPABASE_SERVICE_ROLE_KEY") ?? "");
+    // Fetch active training program from database
+    const { data: programData, error: programError } = await supabase.from("training_programs").select("title, start_date, duration, class_size").eq("is_active", true).order("created_at", {
+      ascending: false
+    }).limit(1).maybeSingle();
+    if (programError) {
+      console.error("Error fetching training program:", programError);
+    }
+    const courseTitle = programData?.title || "AI Engineering: 12-Week Project-Based Course";
+    const startDate = programData?.start_date ? new Date(programData.start_date).toLocaleDateString('en-US', {
+      month: 'long',
+      day: 'numeric',
+      year: 'numeric',
+      weekday: 'long'
+    }) : "January 4, 2026 (Sunday)";
+    const duration = programData?.duration || "12 weeks";
+    const batchSize = programData?.class_size || 10;
     // Idempotency: skip if we've already sent emails for this session
     const markerPath = `flags/email_sent_${sessionId}.txt`;
     try {
@@ -249,11 +265,11 @@
               <div style="background:#f8fafc; border-radius:12px; padding:24px; margin-bottom:24px; border-left:4px solid #3b82f6;">
                 <h2 style="color:#0f172a; margin:0 0 12px 0; font-size:18px;">Course Details</h2>
                 <table style="width:100%; color:#334155; line-height:1.6;">
-                  <tr><td style="padding:6px 0; font-weight:600;">Start Date</td><td style="padding:6px 0;">October 12, 2025 (Sunday)</td></tr>
+                  <tr><td style="padding:6px 0; font-weight:600;">Start Date</td><td style="padding:6px 0;">${startDate}</td></tr>
                   <tr><td style="padding:6px 0; font-weight:600;">Schedule</td><td style="padding:6px 0;">Sundays, 11:00 AM CST (2 hours/week)</td></tr>
                   <tr><td style="padding:6px 0; font-weight:600;">Format</td><td style="padding:6px 0;">Live on Zoom â€¢ Recordings provided</td></tr>
                   <tr><td style="padding:6px 0; font-weight:600;">Community</td><td style="padding:6px 0;">Slack collaboration â€¢ 7-day support</td></tr>
-                  <tr><td style="padding:6px 0; font-weight:600;">Batch Size</td><td style="padding:6px 0;">Max 10 students per batch</td></tr>
+                  <tr><td style="padding:6px 0; font-weight:600;">Batch Size</td><td style="padding:6px 0;">Max ${batchSize} students per batch</td></tr>
                 </table>
               </div>
 
@@ -293,88 +309,28 @@
         </body>
       </html>
     `;
-    // Send customer confirmation email
-    const { error: customerError } = await resend.emails.send({
-      from: "Xyntra AI <noreply@xyntraai.com>",
-      to: [
-        email
-      ],
-      reply_to: "info@xyntraai.com",
-      subject: "Enrollment Confirmation - AI Engineering Course",
-      html: customerEmailHtml,
-      attachments: attachments.length > 0 ? attachments : undefined
-    });
-    if (customerError) {
-      throw new Error(`Resend API error: ${customerError.message}`);
-    }
-    // Send admin notification email
-    const adminEmailHtml = `
-      <!DOCTYPE html>
-      <html lang="en">
-        <head>
-          <meta charset="UTF-8" />
-          <meta name="viewport" content="width=device-width, initial-scale=1.0" />
-          <title>New Enrollment</title>
-        </head>
-        <body style="margin:0; padding:0; background-color:#f8fafc; font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;">
-          <div style="max-width:600px; margin:0 auto; background-color:#ffffff;">
-            <div style="background:linear-gradient(135deg,#1e40af 0%,#3b82f6 100%); padding:28px 24px; text-align:center;">
-              <img src="https://xyntraai.com/assets/xyntra-logo.jpeg" alt="Xyntra AI Solutions" style="max-height:64px; margin-bottom:10px;" />
-              <h1 style="color:#ffffff; margin:6px 0 0; font-size:24px; font-weight:800;">New Enrollment Alert</h1>
-              <p style="color:#dbeafe; margin:6px 0 0; font-size:15px;">AI Engineering Course - Student Enrolled</p>
-            </div>
-
-            <div style="padding:28px 24px;">
-              <div style="background:#f8fafc; border-radius:12px; padding:20px; margin-bottom:20px; border-left:4px solid #3b82f6;">
-                <h2 style="color:#0f172a; margin:0 0 10px 0; font-size:18px;">Student Information</h2>
-                <ul style="color:#334155; line-height:1.7; margin:0; padding-left:18px;">
-                  <li><strong>Name:</strong> ${enrollmentData.name}</li>
-                  <li><strong>Email:</strong> ${enrollmentData.email}</li>
-                  <li><strong>Phone:</strong> ${enrollmentData.phone}</li>
-                  <li><strong>Experience Level:</strong> ${enrollmentData.experience}</li>
-                  <li><strong>Learning Goals:</strong> ${enrollmentData.goals}</li>
-                </ul>
-              </div>
-
-              <div style="background:#ecfdf5; border-radius:12px; padding:20px; margin-bottom:8px; border-left:4px solid #10b981;">
-                <h2 style="color:#065f46; margin:0 0 10px 0; font-size:18px;">Payment Details</h2>
-                <ul style="color:#047857; line-height:1.7; margin:0; padding-left:18px;">
-                  <li><strong>Amount:</strong> $${amount.toFixed(2)} ${currency}</li>
-                  <li><strong>Session ID:</strong> ${session.id}</li>
-                  ${enrollmentData.paymentIntentId ? `<li><strong>Payment ID:</strong> ${enrollmentData.paymentIntentId}</li>` : ''}
-                  <li><strong>Payment Status:</strong> ${session.payment_status}</li>
-                </ul>
-                ${enrollmentData.receiptUrl ? `<p style="margin:12px 0 0 0; font-size:13px;"><a href="${enrollmentData.receiptUrl}" style="color:#047857; text-decoration:underline;">View Stripe Receipt</a></p>` : ''}
-                ${enrollmentData.invoiceUrl ? `<p style="margin:6px 0 0 0; font-size:13px;"><a href="${enrollmentData.invoiceUrl}" style="color:#047857; text-decoration:underline;">View Stripe Invoice</a></p>` : ''}
-              </div>
-            </div>
-
-            <div style="background:#0f172a; padding:18px; text-align:center;">
-              <p style="color:#e2e8f0; margin:0 0 6px 0; font-size:13px; font-weight:600;">Xyntra AI Solutions Inc.</p>
-              <p style="color:#94a3b8; margin:0 0 8px 0; font-size:12px;">Support: <a href="mailto:info@xyntraai.com" style="color:#60a5fa; text-decoration:none;">info@xyntraai.com</a></p>
-              <p style="margin:0;">
-                <a href="https://xyntraai.com" style="color:#60a5fa; text-decoration:none; font-weight:600;">xyntraai.com</a>
-              </p>
-            </div>
-          </div>
-        </body>
-      </html>
-    `;
-    const { error: adminError } = await resend.emails.send({
-      from: "Xyntra AI Enrollment System <noreply@xyntraai.com>",
-      to: [
-        "info@xyntraai.com"
-      ],
-      cc: [
-        "xyntraaisolutions@gmail.com"
-      ],
-      reply_to: "info@xyntraai.com",
-      subject: "New Course Enrollment - AI Engineering Course",
-      html: adminEmailHtml,
-      attachments: attachments.length > 0 ? attachments : undefined
-    });
-    if (adminError) {
-      console.error("Failed to send admin notification email:", adminError);
+    // Get student name from metadata or customer
+    const firstName = session.metadata?.first_name || customer?.name?.split(' ')[0] || 'Student';
+    const lastName = session.metadata?.last_name || customer?.name?.split(' ').slice(1).join(' ') || '';
+    // Call the send-enrollment-confirmation function
+    try {
+      const { error: enrollmentEmailError } = await supabase.functions.invoke('send-enrollment-confirmation', {
+        body: {
+          email,
+          firstName,
+          lastName,
+          sessionId: session.id,
+          amount: amount.toFixed(2)
+        }
+      });
+      if (enrollmentEmailError) {
+        console.error('Error calling send-enrollment-confirmation:', enrollmentEmailError);
+        throw enrollmentEmailError;
+      }
+      console.log("Enrollment confirmation emails sent successfully for session:", sessionId);
+    } catch (error) {
+      console.error('Failed to send enrollment confirmation:', error);
+      throw new Error(`Failed to send enrollment confirmation: ${error.message}`);
     }
     // Write idempotency marker so we won't resend for this session again
     try {
@@ -386,8 +342,7 @@
       console.error('Failed to write idempotency marker:', e);
     }
     return new Response(JSON.stringify({
-      status: "sent",
-      admin_notified: !adminError
+      status: "sent"
     }), {
       headers: {
         ...corsHeaders,</pre></td>
                    </tr>
            </tbody>
        </table>
    </div>
</body>
</html>